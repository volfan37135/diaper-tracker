{% extends "base.html" %}
{% block title %}Purchase History - Diaper Tracker{% endblock %}

{% block content %}
<h1>Purchase History</h1>

{% if purchases %}
<div class="table-responsive">
    <table class="table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Brand</th>
                <th>Boxes</th>
                <th>Per Box</th>
                <th>Total Diapers</th>
                <th>Cost</th>
                <th>$/Diaper</th>
                <th>Date Opened</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for p in purchases %}
            {% set total = p.num_boxes * p.diapers_per_box %}
            {% set cpd = p.cost / total if total > 0 else 0 %}
            {% set openings = box_openings.get(p.id, []) %}
            {% set opened_list = openings|selectattr('date_opened')|list %}
            {% set opened_count = opened_list|length %}
            <tr class="purchase-row">
                <td>{{ p.date }}</td>
                <td>{{ p.brand }}</td>
                <td>{{ p.num_boxes }}</td>
                <td>{{ p.diapers_per_box }}</td>
                <td>{{ total }}</td>
                <td>${{ "%.2f"|format(p.cost) }}</td>
                <td>${{ "%.4f"|format(cpd) }}</td>
                <td class="date-opened-cell">
                    {% if opened_count == p.num_boxes and opened_count > 0 %}
                    <span class="date-opened-status all-opened">{{ opened_list[0].date_opened }}</span>
                    {% elif opened_count > 0 %}
                    <span class="date-opened-status some-opened">{{ opened_count }}/{{ p.num_boxes }} opened</span>
                    {% else %}
                    <span class="date-opened-status not-opened">Not opened</span>
                    {% endif %}
                </td>
                <td class="actions-cell">
                    <form method="POST" action="{{ url_for('delete_purchase', purchase_id=p.id) }}"
                          class="inline-form"
                          onsubmit="return confirm('Delete this purchase record?')">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                    </form>
                </td>
            </tr>
            <tr class="box-opening-row">
                <td colspan="9">
                    <div class="box-opening-strip">
                        <span class="box-opening-label">
                            Boxes opened: <strong>{{ opened_count }}/{{ p.num_boxes }}</strong>
                        </span>
                        <div class="box-opening-items">
                            {% for box in openings %}
                            <div class="box-chip {% if box.date_opened %}chip-opened{% else %}chip-unopened{% endif %}">
                                <span class="chip-label">Box {{ box.box_number }}</span>
                                {% if box.date_opened %}
                                <span class="chip-date">{{ box.date_opened }}</span>
                                {% endif %}
                                <form method="POST" action="{{ url_for('open_box', purchase_id=p.id) }}" class="inline-form chip-form">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="opening_id" value="{{ box.id }}">
                                    <input type="date" name="date_opened" value="{{ box.date_opened or today }}" class="chip-date-input">
                                    {% if box.date_opened %}
                                    <button type="submit" class="chip-btn chip-btn-update">Update</button>
                                    {% else %}
                                    <button type="submit" class="chip-btn chip-btn-open">Open</button>
                                    {% endif %}
                                </form>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="export-actions">
    <a href="{{ url_for('export_pdf') }}" class="btn btn-secondary">Export PDF</a>
    <a href="{{ url_for('export_excel') }}" class="btn btn-secondary">Export Excel</a>
</div>
{% else %}
<p class="empty-state">No purchases recorded yet. <a href="{{ url_for('add_purchase') }}">Add your first purchase!</a></p>
{% endif %}
{% endblock %}
